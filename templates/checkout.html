{% extends "base.html" %}
{% block content %}

<title>Stripe Payment</title>
<script src="https://js.stripe.com/v3/"></script>

<style>
  #payment-element { margin-bottom: 20px; }
  #payment-message { color: red; }
</style>

<h2>Pay ₹{{ '%.2f' | format(totals.grand_total) }}</h2>

<table>
  <tr>
    <td>Subtotal</td>
    <td>₹{{ '%.2f' | format(totals.subtotal) }}</td>
  </tr>
  <tr>
    <td>Shipping</td>
    <td>
      {% if totals.free_shipping %}
        <span style="color: green;">Free</span>
      {% else %}
        ₹{{ '%.2f' | format(totals.shipping) }}
      {% endif %}
    </td>
  </tr>
  <tr>
    <td>Card Fee</td>
    <td>₹{{ '%.2f' | format(totals.card_fee) }}</td>
  </tr>
  <tr>
    <td><strong>Total</strong></td>
    <td><strong>₹{{ '%.2f' | format(totals.grand_total) }}</strong></td>
  </tr>
</table>

{% if current_user.current_address %}
<form id="payment-form">
  <div id="payment-element"></div>
  <button id="submit" class="btn btn-success">Pay</button>
  <div id="payment-message"></div>
</form>

<p>Success: 4242 4242 4242 4242</p>
<p>Auth required: 4000 0025 0000 3155</p>
<p>Declined: 4000 0000 0000 9995</p>
{% endif %}

<h4>Shipping Address</h4>
<div class="card p-3" style="max-width: 400px;">
  {% if current_user.current_address %}
    <p><strong>Name:</strong> {{ current_user.name }}</p>
    <p><strong>Street:</strong> {{ current_user.current_address.street }}</p>
    <p><strong>City:</strong> {{ current_user.current_address.city }}</p>
    <p><strong>Postcode:</strong> {{ current_user.current_address.postcode }}</p>
    <p><strong>Country:</strong> GB</p>
  {% else %}
    <p>No current address set.
      <a href="{{ url_for('profile_addresses') }}">Set one in your profile</a>.
    </p>
  {% endif %}
</div>

<script>
const form = document.getElementById('payment-form');
if (form) {
  let stripe, elements;

  fetch('/cart-data')
    .then(res => res.json())
    .then(data => fetch('/create-payment-intent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cart: data.items })
    }))
    .then(res => res.json())
    .then(({ clientSecret }) => {
      stripe = Stripe('pk_test_51RTLGdIB4LlFizy67MEzJaNLjWUUuzK0gjjz8cFImGmLnZ4ka468OHpf1dhQg7b25Hm180PfPh16BPEhVwq9Wcu100563RRNWV');

      elements = stripe.elements({
        clientSecret,
        appearance: { theme: 'flat' }
      });

      elements.create('payment').mount('#payment-element');
    });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit');
    btn.disabled = true;

    const { error } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: window.location.origin + '/success'
      }
    });

    if (error) {
      document.getElementById('payment-message').textContent = error.message;
      btn.disabled = false;
    }
  });
}
</script>

{% endblock %}

