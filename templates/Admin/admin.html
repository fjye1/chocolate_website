{% extends "Admin/admin_base.html" %}
{% block title %}Admin Home{% endblock %}

{% block admin_block %}

<!-- Main content area (Unfulfilled Orders + Sales Chart) -->
<div class="col-md-9">
    <div class="row">
        <!-- Sales Chart -->
        <div class="row mt-4">
            <!-- Sales Chart (large column) -->
            <div class="col-md-9">
                <h3>Last 28 Days Sales</h3>
                <canvas id="salesChart"></canvas>
            </div>

            <!-- Total Sales (smaller column) -->
            <div class="col-md-3 text-center">
                <h3>Total Sales Last 28 Days</h3>
                <h1>₹{{ total | round(2) }}</h1>
            </div>
        </div>
        <!-- Unfulfilled Orders -->
        <div class="container mt-4">
            <h2>All Orders</h2>
            <table class="table table-bordered table-hover mt-3">
                <thead>
                <tr>
                    <th>Order ID</th>
                    <th>User</th>
                    <th>Date</th>
                    <th>Total (₹)</th>
                    <th>Status</th>
                    <th>View</th>
                    <th>Tracking</th>
                </tr>
                </thead>
                <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_id }}</td>
                    <td>{{ order.user.name }}</td>
                    <td>{{ order.order_date.strftime("%Y-%m-%d %H:%M") }}</td>
                    <td>{{ "%.2f"|format(order.total_amount) }}</td>
                    <td>{{ order.status }}</td>
                    <td>
                        <a href="{{ url_for('invoice', order_id=order.order_id) }}"
                           class="btn btn-sm btn-primary">View</a>
                    </td>
                    <td>
                        {% if order.tracking_number %}
                        <button class="btn btn-success btn-sm" disabled>Sent</button>
                        {% else %}
                        <a href="{{ url_for('add_tracking', order_id=order.order_id) }}" class="btn btn-danger btn-sm">Add
                            Tracking</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>


    </div>
</div>
<form action="{{ url_for('run_dynamic_pricing') }}" method="get">
    <button type="submit" class="btn btn-warning">Run Dynamic Pricing</button>
</form>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('salesChart').getContext('2d');
const salesChart = new Chart(ctx, {
    type: 'line',  // changed to line
    data: {
        labels: {{ day_labels|tojson }},
        datasets: [{
            label: 'Sales (₹)',
            data: {{ sales_values|tojson }},
            backgroundColor: 'rgba(135, 206, 235, 0.2)',
            borderColor: 'skyblue',
            borderWidth: 2,
            fill: true,
            tension: 0.3  // smooth line
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true }
        },
        plugins: {
            legend: { display: true, position: 'top' }
        }
    }
});
</script>
{% endblock %}